<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Empirical Bayes Deconvolution â€¢ deconvolveR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Empirical Bayes Deconvolution">
<meta property="og:description" content="deconvolveR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">deconvolveR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2-1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/deconvolution.html">Empirical Bayes Deconvolution</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/bnaras/deconvolveR/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="deconvolution_files/header-attrs-2.3/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Empirical Bayes Deconvolution</h1>
                        <h4 class="author">Balasubramanian Narasimhan and Bradley Efron</h4>
            
            <h4 class="date">2020-08-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bnaras/deconvolveR/blob/master/vignettes/deconvolution.Rmd"><code>vignettes/deconvolution.Rmd</code></a></small>
      <div class="hidden name"><code>deconvolution.Rmd</code></div>

    </div>

    
    
<div id="a-simulation-example" class="section level2">
<h2 class="hasAnchor">
<a href="#a-simulation-example" class="anchor"></a>A simulation example</h2>
<p>We start with a simulated Poisson example where the <span class="math inline">\(\Theta_i\)</span> are drawn from a chi-squared density with 10 degrees of freedom and the <span class="math inline">\(X_i|\Theta_i\)</span> are Poisson with expectation <span class="math inline">\(\Theta_i:\)</span></p>
<p><span class="math display">\[
\Theta_i \sim \chi^2_{10} \mbox{ and } X_i|\Theta_i \sim \mbox{Poisson}(\Theta_i)
\]</span></p>
<p>The <span class="math inline">\(\Theta_i\)</span> for this setting, with <code>N = 1000</code> observations can be generated as follows.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">238923</span>) <span class="co">## for reproducibility</span>
<span class="no">N</span> <span class="kw">&lt;-</span> <span class="fl">1000</span>
<span class="no">Theta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">rchisq</a></span>(<span class="no">N</span>,  <span class="kw">df</span> <span class="kw">=</span> <span class="fl">10</span>)</pre></body></html></div>
<p>Next, the <span class="math inline">\(X_i|\Theta_i\)</span>, for each of <code>nSIM = 1000</code> simulations can be generated as below.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">nSIM</span> <span class="kw">&lt;-</span> <span class="fl">1000</span>
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="no">nSIM</span>), <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="no">N</span>, <span class="kw">lambda</span> <span class="kw">=</span> <span class="no">Theta</span>))</pre></body></html></div>
<p>We take the discrete set <span class="math inline">\(\mathcal{T}=(1, 2, \ldots, 32)\)</span> as the <span class="math inline">\(\Theta\)</span>-space and apply the <code>deconv</code> function in the package <code>deconvolveR</code> to estimate <span class="math inline">\(g(\theta).\)</span></p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">deconvolveR</span>)
<span class="no">tau</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fl">32</span>)
<span class="no">results</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">data</span>, <span class="fl">2</span>,
                 <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">X</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">ignoreZero</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                                    <span class="kw">c0</span> <span class="kw">=</span> <span class="fl">1</span>))</pre></body></html></div>
<p>The default setting for <code>deconv</code> uses the <code>Poisson</code> family and a natural cubic spline basis of degree 5 as <span class="math inline">\(Q.\)</span> The regularization parameter for this example (<code>c0</code>) is set to 1. The <code>ignoreZero</code> parameter indicates that this dataset contains zero counts, i.e., there zeros have not been truncated. (In the Shakespeare example below, the counts are of words seen in the canon, and so there is a natural truncation at zero.)</p>
<p>Some warnings are emitted by the <code>nlm</code> routine used for optimization, but they are mostly inconsequential.</p>
<p>Since <code>deconv</code> works on a sample at a time, the result above is a list of lists from which various statistics can be extracted. Below, we construct a table of values for various values of <span class="math inline">\(\Theta\)</span>.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">g</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">results</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">stats</span>[, <span class="st">"g"</span>])
<span class="no">mean</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">g</span>, <span class="fl">1</span>, <span class="no">mean</span>)
<span class="no">SE.g</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">results</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">stats</span>[, <span class="st">"SE.g"</span>])
<span class="no">sd</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">SE.g</span>, <span class="fl">1</span>, <span class="no">mean</span>)
<span class="no">Bias.g</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">results</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>$<span class="no">stats</span>[, <span class="st">"Bias.g"</span>])
<span class="no">bias</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">Bias.g</span>, <span class="fl">1</span>, <span class="no">mean</span>)
<span class="no">gTheta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span>(<span class="no">tau</span>, <span class="kw">df</span> <span class="kw">=</span> <span class="fl">10</span>) - <span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">pchisq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>, <span class="no">tau</span>[-<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">tau</span>)]), <span class="kw">df</span> <span class="kw">=</span> <span class="fl">10</span>)
<span class="no">gTheta</span> <span class="kw">&lt;-</span> <span class="no">gTheta</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">gTheta</span>)
<span class="no">simData</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">theta</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">gTheta</span> <span class="kw">=</span> <span class="no">gTheta</span>,
                      <span class="kw">Mean</span> <span class="kw">=</span> <span class="no">mean</span>, <span class="kw">StdDev</span> <span class="kw">=</span> <span class="no">sd</span>, <span class="kw">Bias</span> <span class="kw">=</span> <span class="no">bias</span>,
                      <span class="kw">CoefVar</span> <span class="kw">=</span> <span class="no">sd</span> / <span class="no">mean</span>)
<span class="no">table1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/transform.html">transform</a></span>(<span class="no">simData</span>,
                    <span class="kw">gTheta</span> <span class="kw">=</span> <span class="fl">100</span> * <span class="no">gTheta</span>,
                    <span class="kw">Mean</span> <span class="kw">=</span> <span class="fl">100</span> * <span class="no">Mean</span>,
                    <span class="kw">StdDev</span> <span class="kw">=</span> <span class="fl">100</span> * <span class="no">StdDev</span>,
                    <span class="kw">Bias</span> <span class="kw">=</span> <span class="fl">100</span> * <span class="no">Bias</span>)</pre></body></html></div>
<p>The table below summarizes the results for some chosen values of <span class="math inline">\(\theta .\)</span></p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="no">table1</span>[<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">25</span>), ], <span class="kw">row.names</span><span class="kw">=</span><span class="fl">FALSE</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">theta</th>
<th align="right">gTheta</th>
<th align="right">Mean</th>
<th align="right">StdDev</th>
<th align="right">Bias</th>
<th align="right">CoefVar</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">5</td>
<td align="right">5.6191465</td>
<td align="right">5.4416722</td>
<td align="right">0.3635378</td>
<td align="right">-0.1235865</td>
<td align="right">0.0668063</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">9.1646990</td>
<td align="right">9.5316279</td>
<td align="right">0.4917673</td>
<td align="right">0.2588187</td>
<td align="right">0.0515932</td>
</tr>
<tr class="odd">
<td align="right">15</td>
<td align="right">4.0946148</td>
<td align="right">3.3421426</td>
<td align="right">0.3119862</td>
<td align="right">-0.0683187</td>
<td align="right">0.0933492</td>
</tr>
<tr class="even">
<td align="right">20</td>
<td align="right">1.1014405</td>
<td align="right">0.9810001</td>
<td align="right">0.2246999</td>
<td align="right">-0.1225092</td>
<td align="right">0.2290519</td>
</tr>
<tr class="odd">
<td align="right">25</td>
<td align="right">0.2255788</td>
<td align="right">0.1496337</td>
<td align="right">0.0677919</td>
<td align="right">0.0602422</td>
<td align="right">0.4530522</td>
</tr>
</tbody>
</table>
<p>Although, the coefficient of variation of <span class="math inline">\(\hat{g}(\theta)\)</span> is still large, the <span class="math inline">\(g(\theta)\)</span> estimates are reasonable.</p>
<p>We can compare the empirical standard deviations and biases of <span class="math inline">\(g(\hat{\alpha})\)</span> with the approximation given by the formulas in the paper.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggplot2</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">cowplot</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_set</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html">theme_get</a></span>() +
          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">panel.grid.major</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"gray90"</span>,
                                                <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.2</span>),
                <span class="kw">panel.grid.minor</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"gray98"</span>,
                                                <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.5</span>)))
<span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="no">results</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="no">stats</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">theta</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">SE.g</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"solid"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">simData</span>$<span class="no">theta</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">simData</span>$<span class="no">StdDev</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"dashed"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">theta</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Std. Dev"</span>)

<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="no">results</span><span class="kw">[[</span><span class="fl">1</span>]]$<span class="no">stats</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">theta</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Bias.g</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"solid"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">simData</span>$<span class="no">theta</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">simData</span>$<span class="no">Bias</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"dashed"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">theta</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Bias"</span>)
<span class="fu"><a href="https://rdrr.io/pkg/cowplot/man/plot_grid.html">plot_grid</a></span>(<span class="kw">plotlist</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">p1</span>, <span class="no">p2</span>), <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>The approximation is quite good for the standard deviations, but a little too small for the biases.</p>
</div>
<div id="the-shakespeare-data" class="section level2">
<h2 class="hasAnchor">
<a href="#the-shakespeare-data" class="anchor"></a>The Shakespeare data</h2>
<p>Here we are given the word counts for the entire Shakespeare canon in the data set <code>bardWordCount</code>. We assume the <span class="math inline">\(i\)</span>th distinct word appeared <span class="math inline">\(X_i \sim Poisson(\Theta_i)\)</span> times in the canon.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">bardWordCount</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">bardWordCount</span>)</pre></body></html></div>
<pre><code>##  num [1:100] 14376 4343 2292 1463 1043 ...</code></pre>
<p>We take the support set <span class="math inline">\(\mathcal{T}\)</span> for <span class="math inline">\(\Theta\)</span> to be equally spaced on the log-scale and the sample space for <span class="math inline">\(\mathcal{X}\)</span> to be <span class="math inline">\((1,2,\ldots,100).\)</span></p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">lambda</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(-<span class="fl">4</span>, <span class="fl">4.5</span>, <span class="fl">.025</span>)
<span class="no">tau</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="no">lambda</span>)</pre></body></html></div>
<p>Using a regularization parameter of <code>c0=2</code> we can deconvolve the data to get <span class="math inline">\(\hat{g}.\)</span></p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">bardWordCount</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">c0</span><span class="kw">=</span><span class="fl">2</span>)
<span class="no">stats</span> <span class="kw">&lt;-</span> <span class="no">result</span>$<span class="no">stats</span></pre></body></html></div>
<p>The plot below shows the Empirical Bayes deconvoluation estimates for the Shakespeare word counts.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">lambda</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">stats</span>[, <span class="st">"g"</span>])) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">theta</span>)), <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu">g</span>(<span class="no">theta</span>)))</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>The quantity <span class="math inline">\(R(\alpha)\)</span> in the paper (Efron, Biometrika 2015) can be extracted from the <code>stats</code> list; in this case for a regularization parameter of <code>c0=2</code> we can print its value:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="no">result</span>$<span class="no">S</span>)</pre></body></html></div>
<pre><code>## [1] 0.005534954</code></pre>
<p>The <code>stats</code> list contains other estimates quantities as well.</p>
<p>As noted in the paper citing this package, about 44 percent of the total mass of <span class="math inline">\(\hat{g}\)</span> lies below <span class="math inline">\(\Theta = 1\)</span>, which is an underestimate. This can be corrected for by defining <span class="math display">\[
\tilde{g} = c_1\hat{g} / (1 - e^{-\theta_j}),
\]</span> where <span class="math inline">\(c_1\)</span> is the constant that normalizes <span class="math inline">\(\tilde{g}\)</span>.</p>
<p>When there is truncation at zero, as is the case here, the <code>deconvolveR</code> package now returns an additional column in <code>stats[, "tg"]</code> which contains this correction for <em>thinning</em>. (The default invocation of <code>deconv</code> assumes zero truncation for the Poisson family, argument <code>ignoreZero = FALSE</code>).</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">d</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">lambda</span> <span class="kw">=</span> <span class="no">lambda</span>, <span class="kw">g</span> <span class="kw">=</span> <span class="no">stats</span>[, <span class="st">"g"</span>], <span class="kw">tg</span> <span class="kw">=</span> <span class="no">stats</span>[, <span class="st">"tg"</span>], <span class="kw">SE.g</span> <span class="kw">=</span> <span class="no">stats</span>[, <span class="st">"SE.g"</span>])
<span class="no">indices</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">lambda</span>), <span class="fl">5</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">lambda</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">g</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>[<span class="no">indices</span>, ],
                  <span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">lambda</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">g</span> - <span class="no">SE.g</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">g</span> + <span class="no">SE.g</span>),
                  <span class="kw">width</span> <span class="kw">=</span> <span class="fl">.01</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">theta</span>)), <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu">g</span>(<span class="no">theta</span>))) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span>(<span class="fl">0</span>, <span class="fl">0.006</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">lambda</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">tg</span>), <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"dashed"</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>)</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>We can now plot the posterior estimates.</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">gPost</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="fl">100</span>), <span class="kw">function</span>(<span class="no">i</span>) <span class="fu"><a href="https://rdrr.io/r/base/eval.html">local</a></span>({<span class="no">tg</span> <span class="kw">&lt;-</span> <span class="no">d</span>$<span class="no">tg</span> * <span class="no">result</span>$<span class="no">P</span>[<span class="no">i</span>, ]; <span class="no">tg</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">tg</span>)}))
<span class="no">plots</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span>), <span class="kw">function</span>(<span class="no">i</span>) {
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">gPost</span>[, <span class="no">i</span>])) +
        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">theta</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu">g</span>(<span class="no">theta</span>)),
             <span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"x = %d"</span>, <span class="no">i</span>))
})
<span class="no">plots</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Map</a></span>(<span class="kw">f</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">p</span>, <span class="no">xlim</span>) <span class="no">p</span> + <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">xlim</a></span>(<span class="fl">0</span>, <span class="no">xlim</span>), <span class="no">plots</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="fl">6</span>, <span class="fl">8</span>, <span class="fl">14</span>, <span class="fl">20</span>))
<span class="fu"><a href="https://rdrr.io/pkg/cowplot/man/plot_grid.html">plot_grid</a></span>(<span class="kw">plotlist</span> <span class="kw">=</span> <span class="no">plots</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-14-1.png" width="720"></p>
<div id="bootstrap-comparison" class="section level3">
<h3 class="hasAnchor">
<a href="#bootstrap-comparison" class="anchor"></a>Bootstrap Comparison</h3>
<p>As a check, one can perform a parametric bootstrap using <span class="math display">\[
y^{*} \sim Mult_n(N, {\mathbf f})
\]</span> with the MLE <span class="math inline">\(\hat{\mathbf f} = {\mathbf f}(\hat{\alpha})\)</span>. We use 200 bootstrap replcates to compute the standard errors for <span class="math inline">\(\hat{g}\)</span> and compare them to the theoretical values in the plot below. The agreement is pretty good.</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">1783</span>)
<span class="no">B</span> <span class="kw">&lt;-</span> <span class="fl">200</span>
<span class="no">fHat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span>(<span class="no">result</span>$<span class="no">P</span> <span class="kw">%*%</span> <span class="no">d</span>$<span class="no">g</span>)
<span class="no">fHat</span> <span class="kw">&lt;-</span> <span class="no">fHat</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">fHat</span>)
<span class="no">yStar</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Multinom.html">rmultinom</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="no">B</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">bardWordCount</span>), <span class="kw">prob</span> <span class="kw">=</span> <span class="no">fHat</span>)
<span class="no">gBoot</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">yStar</span>, <span class="fl">2</span>,
               <span class="kw">function</span>(<span class="no">y</span>) <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">n</span> <span class="kw">=</span> <span class="fl">100</span>, <span class="kw">c0</span> <span class="kw">=</span> <span class="fl">2</span>)$<span class="no">stats</span>[, <span class="st">"g"</span>])
<span class="no">seG</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">gBoot</span>, <span class="fl">1</span>, <span class="no">sd</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">lambda</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">SE.g</span>,
                            <span class="kw">color</span> <span class="kw">=</span> <span class="st">"Theoretical"</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"Theoretical"</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">lambda</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">seG</span>,
                            <span class="kw">color</span> <span class="kw">=</span> <span class="st">"Bootstrap"</span>, <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"Bootstrap"</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"Legend"</span>,
                       <span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Bootstrap"</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="st">"Theoretical"</span> <span class="kw">=</span> <span class="st">"red"</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_linetype_manual</a></span>(<span class="kw">name</span> <span class="kw">=</span> <span class="st">"Legend"</span>,
                          <span class="kw">values</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Bootstrap"</span> <span class="kw">=</span> <span class="st">"solid"</span>, <span class="st">"Theoretical"</span> <span class="kw">=</span> <span class="st">"dashed"</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(<span class="kw">legend.title</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>()) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="no">theta</span>)), <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/sigma.html">sigma</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/influence.measures.html">hat</a></span>(<span class="no">g</span>))))</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
<div id="predict-ratio-of-new-distinct-words" class="section level3">
<h3 class="hasAnchor">
<a href="#predict-ratio-of-new-distinct-words" class="anchor"></a>Predict ratio of new distinct words</h3>
<p>Suppose then that a previously unknown Shakespearean corpus of length <span class="math inline">\(t\times C\)</span> were found, <span class="math inline">\(C\times 900,000\)</span> the length of the known canon. Assuming a Poisson process model with intensity <span class="math inline">\(\Theta_i\)</span> for word <span class="math inline">\(i\)</span>, the probability that word <span class="math inline">\(i\)</span> did not appear in the canon but does appear in the new corpus is <span class="math display">\[
e^{-\Theta_i}\left(1-e^{-\Theta_it}\right);
\]</span> yielding after some work, an estimate for <span class="math inline">\(R(t)\)</span>, the expected number of distinct new words found, divided by <span class="math inline">\(N\)</span>, the observed number of distinct words in the canon: <span class="math display">\[
R(t)=\sum_{j=1}^m\hat{g}_jr_j(t),
\]</span> with <span class="math display">\[
r_j=\frac{e^{-\theta_{(j)}}}{1-e^{-\theta_{(j)}}}\left(1-e^{-\theta_{(j)}t}\right).
\]</span></p>
<p>We can compute the <span class="math inline">\(R(t)\)</span> and plot it as follows.</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">gHat</span> <span class="kw">&lt;-</span> <span class="no">stats</span>[, <span class="st">"g"</span>]
<span class="no">Rfn</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">t</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>( <span class="no">gHat</span> * (<span class="fl">1</span> - <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">tau</span> * <span class="no">t</span>)) / (<span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(<span class="no">tau</span>) - <span class="fl">1</span>) )
}
<span class="no">r</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">0</span>:<span class="fl">10</span>, <span class="no">Rfn</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fl">0</span>:<span class="fl">10</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">r</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"time multiple t"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu">R</span>(<span class="no">t</span>)))</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>And the (speculative) doubling time for Shakespeareâ€™s vocabulary is easy to compute too.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/uniroot.html">uniroot</a></span>(<span class="kw">f</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>) <span class="fu">Rfn</span>(<span class="no">x</span>) - <span class="fl">1</span>, <span class="kw">interval</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">2</span>, <span class="fl">4</span>))$<span class="no">root</span>)</pre></body></html></div>
<pre><code>## [1] 3.653132</code></pre>
</div>
</div>
<div id="normal-example" class="section level2">
<h2 class="hasAnchor">
<a href="#normal-example" class="anchor"></a>Normal Example</h2>
<p>Consider a data set that is generated via the following mechanism.</p>
<p><span class="math display">\[
z_i \sim N(\mu_i, 1), \mbox{ $i = 1,2,\ldots, N = 10,000$}
\]</span></p>
<p>with</p>
<p><span class="math display">\[
\mu_i=
    \begin{cases}
        0,        &amp; \mbox{with probability .9}\\
        N(-3, 1), &amp; \mbox{with probability .1}\\
    \end{cases}
\]</span></p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">129023</span>)
<span class="no">N</span> <span class="kw">&lt;-</span> <span class="fl">10000</span>
<span class="no">pi0</span> <span class="kw">&lt;-</span> <span class="fl">.90</span>
<span class="no">data</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">local</a></span>({
    <span class="no">nullCase</span> <span class="kw">&lt;-</span> (<span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="no">N</span>) <span class="kw">&lt;=</span> <span class="no">pi0</span>)
    <span class="no">muAndZ</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">nullCase</span>, <span class="kw">function</span>(<span class="no">isNull</span>) {
        <span class="kw">if</span> (<span class="no">isNull</span>) {
            <span class="no">mu</span> <span class="kw">&lt;-</span> <span class="fl">0</span>
            <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">mu</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1</span>))
        } <span class="kw">else</span> {
            <span class="no">mu</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1</span>, <span class="kw">mean</span> <span class="kw">=</span> -<span class="fl">3</span>)
            <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">mu</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fl">1</span>, <span class="kw">mean</span> <span class="kw">=</span> <span class="no">mu</span>))
        }
    }))
    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">nullCase</span> <span class="kw">=</span> <span class="no">nullCase</span>, <span class="kw">mu</span> <span class="kw">=</span> <span class="no">muAndZ</span>[, <span class="fl">1</span>], <span class="kw">z</span> <span class="kw">=</span> <span class="no">muAndZ</span>[, <span class="fl">2</span>])
})</pre></body></html></div>
<p>Below is a histogram of the data (<span class="math inline">\(z\)</span> values) and that of the <span class="math inline">\(\Theta\)</span>s.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">data</span>$<span class="no">z</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span>  <span class="kw">=</span> <span class="no">..count..</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">..count..</span>) ),
                   <span class="kw">color</span> <span class="kw">=</span> <span class="st">"brown"</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">60</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"z"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Density"</span>)
<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">data</span>$<span class="no">mu</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span>  <span class="kw">=</span> <span class="no">..count..</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">..count..</span>) ),
                   <span class="kw">color</span> <span class="kw">=</span> <span class="st">"brown"</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">60</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">theta</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Density"</span>)
<span class="fu"><a href="https://rdrr.io/pkg/cowplot/man/plot_grid.html">plot_grid</a></span>(<span class="kw">plotlist</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">p1</span>, <span class="no">p2</span>), <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>Now we deconvolve this using <span class="math inline">\(\mathcal{T} = (-6, -5.75,\ldots, 3)\)</span> and a spike at zero and a fifth-degree polynomial.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">tau</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw">from</span> <span class="kw">=</span> -<span class="fl">6</span>, <span class="kw">to</span> <span class="kw">=</span> <span class="fl">3</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fl">0.25</span>)
<span class="no">atomIndex</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">tau</span> <span class="kw">==</span> <span class="fl">0</span>)
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">X</span> <span class="kw">=</span> <span class="no">data</span>$<span class="no">z</span>, <span class="kw">deltaAt</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"Normal"</span>, <span class="kw">pDegree</span> <span class="kw">=</span> <span class="fl">5</span>)</pre></body></html></div>
<p>The estimates and the standard errors of the penalized MLE <span class="math inline">\(\hat{g}\)</span> with <code>c0 = 1</code> are shown below.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="no">result</span>$<span class="no">stats</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">theta</th>
<th align="right">g</th>
<th align="right">SE.g</th>
<th align="right">G</th>
<th align="right">SE.G</th>
<th align="right">Bias.g</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">-6.00</td>
<td align="right">0.0001755</td>
<td align="right">0.0001139</td>
<td align="right">0.0001755</td>
<td align="right">0.0001139</td>
<td align="right">0.0002100</td>
</tr>
<tr class="even">
<td align="right">-5.75</td>
<td align="right">0.0003137</td>
<td align="right">0.0001627</td>
<td align="right">0.0004892</td>
<td align="right">0.0002764</td>
<td align="right">0.0002944</td>
</tr>
<tr class="odd">
<td align="right">-5.50</td>
<td align="right">0.0005542</td>
<td align="right">0.0002188</td>
<td align="right">0.0010434</td>
<td align="right">0.0004943</td>
<td align="right">0.0003817</td>
</tr>
<tr class="even">
<td align="right">-5.25</td>
<td align="right">0.0009558</td>
<td align="right">0.0002710</td>
<td align="right">0.0019991</td>
<td align="right">0.0007611</td>
<td align="right">0.0004355</td>
</tr>
<tr class="odd">
<td align="right">-5.00</td>
<td align="right">0.0015902</td>
<td align="right">0.0003068</td>
<td align="right">0.0035893</td>
<td align="right">0.0010496</td>
<td align="right">0.0003936</td>
</tr>
<tr class="even">
<td align="right">-4.75</td>
<td align="right">0.0025218</td>
<td align="right">0.0003396</td>
<td align="right">0.0061111</td>
<td align="right">0.0013181</td>
<td align="right">0.0001835</td>
</tr>
<tr class="odd">
<td align="right">-4.50</td>
<td align="right">0.0037665</td>
<td align="right">0.0004384</td>
<td align="right">0.0098775</td>
<td align="right">0.0015480</td>
<td align="right">-0.0002271</td>
</tr>
<tr class="even">
<td align="right">-4.25</td>
<td align="right">0.0052352</td>
<td align="right">0.0006237</td>
<td align="right">0.0151127</td>
<td align="right">0.0017954</td>
<td align="right">-0.0007502</td>
</tr>
<tr class="odd">
<td align="right">-4.00</td>
<td align="right">0.0067030</td>
<td align="right">0.0007782</td>
<td align="right">0.0218157</td>
<td align="right">0.0021384</td>
<td align="right">-0.0011392</td>
</tr>
<tr class="even">
<td align="right">-3.75</td>
<td align="right">0.0079323</td>
<td align="right">0.0008168</td>
<td align="right">0.0297481</td>
<td align="right">0.0025338</td>
<td align="right">-0.0011786</td>
</tr>
<tr class="odd">
<td align="right">-3.50</td>
<td align="right">0.0087575</td>
<td align="right">0.0007875</td>
<td align="right">0.0385055</td>
<td align="right">0.0028572</td>
<td align="right">-0.0008249</td>
</tr>
<tr class="even">
<td align="right">-3.25</td>
<td align="right">0.0091050</td>
<td align="right">0.0008190</td>
<td align="right">0.0476105</td>
<td align="right">0.0030494</td>
<td align="right">-0.0001984</td>
</tr>
<tr class="odd">
<td align="right">-3.00</td>
<td align="right">0.0089988</td>
<td align="right">0.0009356</td>
<td align="right">0.0566093</td>
<td align="right">0.0031703</td>
<td align="right">0.0004827</td>
</tr>
<tr class="even">
<td align="right">-2.75</td>
<td align="right">0.0085341</td>
<td align="right">0.0010240</td>
<td align="right">0.0651434</td>
<td align="right">0.0033244</td>
<td align="right">0.0009991</td>
</tr>
<tr class="odd">
<td align="right">-2.50</td>
<td align="right">0.0078394</td>
<td align="right">0.0010049</td>
<td align="right">0.0729829</td>
<td align="right">0.0035304</td>
<td align="right">0.0012035</td>
</tr>
<tr class="even">
<td align="right">-2.25</td>
<td align="right">0.0070391</td>
<td align="right">0.0009187</td>
<td align="right">0.0800220</td>
<td align="right">0.0036975</td>
<td align="right">0.0010485</td>
</tr>
<tr class="odd">
<td align="right">-2.00</td>
<td align="right">0.0062096</td>
<td align="right">0.0009410</td>
<td align="right">0.0862316</td>
<td align="right">0.0037737</td>
<td align="right">0.0006476</td>
</tr>
<tr class="even">
<td align="right">-1.75</td>
<td align="right">0.0053923</td>
<td align="right">0.0011197</td>
<td align="right">0.0916239</td>
<td align="right">0.0038631</td>
<td align="right">0.0001722</td>
</tr>
<tr class="odd">
<td align="right">-1.50</td>
<td align="right">0.0046182</td>
<td align="right">0.0013216</td>
<td align="right">0.0962421</td>
<td align="right">0.0041634</td>
<td align="right">-0.0002559</td>
</tr>
<tr class="even">
<td align="right">-1.25</td>
<td align="right">0.0039083</td>
<td align="right">0.0014443</td>
<td align="right">0.1001503</td>
<td align="right">0.0047866</td>
<td align="right">-0.0005669</td>
</tr>
<tr class="odd">
<td align="right">-1.00</td>
<td align="right">0.0032743</td>
<td align="right">0.0014544</td>
<td align="right">0.1034247</td>
<td align="right">0.0056648</td>
<td align="right">-0.0007344</td>
</tr>
<tr class="even">
<td align="right">-0.75</td>
<td align="right">0.0027209</td>
<td align="right">0.0013594</td>
<td align="right">0.1061456</td>
<td align="right">0.0066420</td>
<td align="right">-0.0007631</td>
</tr>
<tr class="odd">
<td align="right">-0.50</td>
<td align="right">0.0022468</td>
<td align="right">0.0011884</td>
<td align="right">0.1083923</td>
<td align="right">0.0075782</td>
<td align="right">-0.0006763</td>
</tr>
<tr class="even">
<td align="right">-0.25</td>
<td align="right">0.0018442</td>
<td align="right">0.0009889</td>
<td align="right">0.1102365</td>
<td align="right">0.0083898</td>
<td align="right">-0.0005154</td>
</tr>
<tr class="odd">
<td align="right">0.00</td>
<td align="right">0.8846685</td>
<td align="right">0.0103603</td>
<td align="right">0.9949050</td>
<td align="right">0.0032481</td>
<td align="right">-0.0007798</td>
</tr>
<tr class="even">
<td align="right">0.25</td>
<td align="right">0.0012121</td>
<td align="right">0.0006634</td>
<td align="right">0.9961171</td>
<td align="right">0.0026657</td>
<td align="right">-0.0001414</td>
</tr>
<tr class="odd">
<td align="right">0.50</td>
<td align="right">0.0009670</td>
<td align="right">0.0005580</td>
<td align="right">0.9970841</td>
<td align="right">0.0021484</td>
<td align="right">0.0000199</td>
</tr>
<tr class="even">
<td align="right">0.75</td>
<td align="right">0.0007616</td>
<td align="right">0.0004773</td>
<td align="right">0.9978457</td>
<td align="right">0.0016891</td>
<td align="right">0.0001464</td>
</tr>
<tr class="odd">
<td align="right">1.00</td>
<td align="right">0.0005909</td>
<td align="right">0.0004069</td>
<td align="right">0.9984366</td>
<td align="right">0.0012899</td>
<td align="right">0.0002343</td>
</tr>
<tr class="even">
<td align="right">1.25</td>
<td align="right">0.0004510</td>
<td align="right">0.0003385</td>
<td align="right">0.9988876</td>
<td align="right">0.0009551</td>
<td align="right">0.0002847</td>
</tr>
<tr class="odd">
<td align="right">1.50</td>
<td align="right">0.0003383</td>
<td align="right">0.0002718</td>
<td align="right">0.9992259</td>
<td align="right">0.0006855</td>
<td align="right">0.0003024</td>
</tr>
<tr class="even">
<td align="right">1.75</td>
<td align="right">0.0002500</td>
<td align="right">0.0002114</td>
<td align="right">0.9994759</td>
<td align="right">0.0004756</td>
<td align="right">0.0002951</td>
</tr>
<tr class="odd">
<td align="right">2.00</td>
<td align="right">0.0001824</td>
<td align="right">0.0001602</td>
<td align="right">0.9996583</td>
<td align="right">0.0003163</td>
<td align="right">0.0002713</td>
</tr>
<tr class="even">
<td align="right">2.25</td>
<td align="right">0.0001318</td>
<td align="right">0.0001191</td>
<td align="right">0.9997901</td>
<td align="right">0.0001977</td>
<td align="right">0.0002386</td>
</tr>
<tr class="odd">
<td align="right">2.50</td>
<td align="right">0.0000945</td>
<td align="right">0.0000875</td>
<td align="right">0.9998846</td>
<td align="right">0.0001104</td>
<td align="right">0.0002027</td>
</tr>
<tr class="even">
<td align="right">2.75</td>
<td align="right">0.0000674</td>
<td align="right">0.0000639</td>
<td align="right">0.9999520</td>
<td align="right">0.0000466</td>
<td align="right">0.0001677</td>
</tr>
<tr class="odd">
<td align="right">3.00</td>
<td align="right">0.0000480</td>
<td align="right">0.0000466</td>
<td align="right">1.0000000</td>
<td align="right">0.0000000</td>
<td align="right">0.0001360</td>
</tr>
</tbody>
</table>
<p>Per the above table, the estimated probability of <span class="math inline">\(\mu = 0\)</span> is 0.885 <span class="math inline">\(\pm\)</span> 0.01 with a bias of about -0.001.</p>
<p>We can now plot the <span class="math inline">\(g\)</span>-estimate removing the atom at 0.</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">gData</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="no">result</span>$<span class="no">stats</span>[-<span class="no">atomIndex</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"theta"</span>, <span class="st">"g"</span>)])
<span class="no">gData</span>$<span class="no">g</span> <span class="kw">&lt;-</span> <span class="no">gData</span>$<span class="no">g</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">gData</span>$<span class="no">g</span>)
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">gData</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">theta</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">g</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">theta</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(<span class="no">theta</span>, <span class="kw">mean</span> <span class="kw">=</span> -<span class="fl">3</span>)),
                            <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">theta</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu">g</span>(<span class="no">theta</span>)))</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<p>The density approximation is not accurate at all, however, the posterior estimates for the gâ€™s are similar to what one obtains by the Benjamini-Yekutieli procedure as shown below.</p>
<ol style="list-style-type: decimal">
<li>Sort the <span class="math inline">\(p\)</span>-values.</li>
</ol>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span>(<span class="no">data</span>$<span class="no">z</span>)
<span class="no">orderP</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="no">p</span>)
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="no">p</span>[<span class="no">orderP</span>]</pre></body></html></div>
<ol start="2" style="list-style-type: decimal">
<li>Compute <span class="math inline">\(R\)</span>, the number of discoveries and count the number of false discoveries</li>
</ol>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="co">## FCR</span>
<span class="no">q</span> <span class="kw">&lt;-</span> <span class="fl">0.05</span>
<span class="no">R</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">p</span> <span class="kw">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="no">N</span>) * <span class="no">q</span> / <span class="no">N</span>))
<span class="no">discIdx</span> <span class="kw">&lt;-</span> <span class="no">orderP</span>[<span class="fl">1</span>:<span class="no">R</span>]
<span class="no">disc</span> <span class="kw">&lt;-</span> <span class="no">data</span>[<span class="no">discIdx</span>, ]
<span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="st">"BY_q procedure discoveries"</span>, <span class="no">R</span>, <span class="st">"cases,"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">disc</span>$<span class="no">nullCase</span>),
    <span class="st">"actual nulls among them.\n"</span>)</pre></body></html></div>
<pre><code>## BY_q procedure discoveries 610 cases, 22 actual nulls among them.</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Construct Benjamini-Yekutieli and Bayes confidence intervals.</li>
</ol>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">alphaR</span> <span class="kw">&lt;-</span> <span class="fl">1</span> - <span class="no">R</span> * <span class="no">q</span> / <span class="no">N</span>
<span class="no">zAlpha</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span>(<span class="no">alphaR</span>, <span class="kw">lower.tail</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">zMarker</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">disc</span>$<span class="no">z</span>)
<span class="no">xlim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">7.6</span>, <span class="fl">0.0</span>)
<span class="no">ylim</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">10</span>, <span class="fl">0.0</span>)
<span class="no">BY.lo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">xlim</span>[<span class="fl">1</span>] - <span class="no">zAlpha</span>, <span class="no">xlim</span>[<span class="fl">2</span>] - <span class="no">zAlpha</span>)
<span class="no">BY.up</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">xlim</span>[<span class="fl">1</span>] + <span class="no">zAlpha</span>, <span class="no">xlim</span>[<span class="fl">2</span>] + <span class="no">zAlpha</span>)
<span class="no">Bayes.lo</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span> * (<span class="no">xlim</span>[<span class="fl">1</span>] - <span class="fl">3</span>) - <span class="fl">1.96</span> / <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">2</span>), <span class="fl">0.5</span> * (<span class="no">xlim</span>[<span class="fl">2</span>] - <span class="fl">3</span>) - <span class="fl">1.96</span> / <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">2</span>))
<span class="no">Bayes.up</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span> * (<span class="no">xlim</span>[<span class="fl">1</span>] - <span class="fl">3</span>) + <span class="fl">1.96</span> / <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">2</span>), <span class="fl">0.5</span> * (<span class="no">xlim</span>[<span class="fl">2</span>] - <span class="fl">3</span>) + <span class="fl">1.96</span> / <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="fl">2</span>))</pre></body></html></div>
<ol start="4" style="list-style-type: decimal">
<li>Compute the estimated posterior density for of <span class="math inline">\(\mu\)</span> given <span class="math inline">\(z\)</span> and construct the 95% credible intervals for <span class="math inline">\(\mu\)</span> given <span class="math inline">\(z\)</span>.</li>
</ol>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="no">d</span> <span class="kw">&lt;-</span> <span class="no">data</span>[<span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span>(<span class="no">data</span>$<span class="no">mu</span>), ]
<span class="no">muVals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">d</span>$<span class="no">mu</span>)
<span class="no">s</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="no">result</span>$<span class="no">stats</span>)
<span class="no">indices</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/findInterval.html">findInterval</a></span>(<span class="no">muVals</span>, <span class="no">s</span>$<span class="no">theta</span>) + <span class="fl">1</span>
<span class="no">gMu</span> <span class="kw">&lt;-</span> <span class="no">s</span>$<span class="no">g</span>[<span class="no">indices</span>]
<span class="no">st</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">data</span>$<span class="no">z</span>), -<span class="fl">2.0</span>, <span class="kw">length.out</span> <span class="kw">=</span> <span class="fl">40</span>)
<span class="no">gMuPhi</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">st</span>, <span class="kw">function</span>(<span class="no">z</span>) <span class="no">gMu</span> * <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span>(<span class="no">z</span> - <span class="no">muVals</span>))
<span class="no">g2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">gMuPhi</span>, <span class="fl">2</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span>(<span class="no">x</span>)/<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">x</span>))
<span class="no">pct</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">g2</span>, <span class="fl">2</span>, <span class="kw">function</span>(<span class="no">dist</span>) <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html">approx</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">muVals</span>, <span class="kw">x</span> <span class="kw">=</span> <span class="no">dist</span>, <span class="kw">xout</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)))
<span class="no">qVals</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">pct</span>, <span class="kw">function</span>(<span class="no">item</span>) <span class="no">item</span>$<span class="no">y</span>)</pre></body></html></div>
<ol start="5" style="list-style-type: decimal">
<li>Plot it</li>
</ol>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">xlim</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">BY.lo</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">xlim</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">BY.up</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">xlim</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Bayes.lo</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"magenta"</span>,
              <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"dashed"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">xlim</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">Bayes.up</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"magenta"</span>,
              <span class="kw">linetype</span> <span class="kw">=</span> <span class="st">"dashed"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">disc</span>$<span class="no">z</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">disc</span>$<span class="no">mu</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">disc</span>$<span class="no">z</span>[<span class="no">disc</span>$<span class="no">nullCase</span>], <span class="kw">y</span> <span class="kw">=</span> <span class="no">disc</span>$<span class="no">mu</span>[<span class="no">disc</span>$<span class="no">nullCase</span>]),
                             <span class="kw">color</span> <span class="kw">=</span> <span class="st">"orange"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">zMarker</span>, <span class="fl">2</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">10</span>, <span class="fl">1</span>))) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">st</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">qVals</span>[<span class="fl">1</span>, ]), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"brown"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">st</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">qVals</span>[<span class="fl">2</span>, ]), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"brown"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Observed z"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">mu</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, <span class="kw">x</span> <span class="kw">=</span> -<span class="fl">1</span>, <span class="kw">y</span> <span class="kw">=</span> -<span class="fl">4.25</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"BY.lo"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, <span class="kw">x</span> <span class="kw">=</span> -<span class="fl">1</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fl">1.25</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"BY.up"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, <span class="kw">x</span> <span class="kw">=</span> -<span class="fl">7.5</span>, <span class="kw">y</span> <span class="kw">=</span> -<span class="fl">6.1</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"Bayes.lo"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, <span class="kw">x</span> <span class="kw">=</span> -<span class="fl">7.5</span>, <span class="kw">y</span> <span class="kw">=</span> -<span class="fl">3.4</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"Bayes.up"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, <span class="kw">x</span> <span class="kw">=</span> -<span class="fl">2.0</span>, <span class="kw">y</span> <span class="kw">=</span> -<span class="fl">1.75</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"EB.lo"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, <span class="kw">x</span> <span class="kw">=</span> -<span class="fl">2.0</span>, <span class="kw">y</span> <span class="kw">=</span> -<span class="fl">3.9</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"EB.up"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, <span class="kw">x</span> <span class="kw">=</span> <span class="no">zMarker</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fl">1.25</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">zMarker</span>, <span class="fl">2</span>)))</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
</div>
<div id="another-normal-example-twin-towers" class="section level2">
<h2 class="hasAnchor">
<a href="#another-normal-example-twin-towers" class="anchor"></a>Another Normal example (Twin Towers)</h2>
<p>In the first normal example, the <span class="math inline">\(\theta\)</span> distribution had a significant atom at 0 and the rest of the density was smeared around -3. We now investigate what happens when the <span class="math inline">\(\theta\)</span> distribution is clearly bimodal. Below is a histogram of the the <span class="math inline">\(\theta\)</span> and alongside a histogram of the data, generated using <span class="math inline">\(X_i \sim N(\theta_i, 1)\)</span>.</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="no">p1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">disjointTheta</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span>  <span class="kw">=</span> <span class="no">..count..</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">..count..</span>) ),
                   <span class="kw">color</span> <span class="kw">=</span> <span class="st">"brown"</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">60</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">theta</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Density"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span> (<span class="fl">2332</span>)
<span class="no">z</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">disjointTheta</span>), <span class="kw">mean</span> <span class="kw">=</span> <span class="no">disjointTheta</span>)
<span class="no">p2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">z</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span>  <span class="kw">=</span> <span class="no">..count..</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">..count..</span>) ),
                   <span class="kw">color</span> <span class="kw">=</span> <span class="st">"brown"</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">60</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"z"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Density"</span>)
<span class="fu"><a href="https://rdrr.io/pkg/cowplot/man/plot_grid.html">plot_grid</a></span>(<span class="kw">plotlist</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">p1</span>, <span class="no">p2</span>), <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
<p>We deconvolve the data, using various values for the spline degrees of freedom.</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="no">tau</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw">from</span> <span class="kw">=</span> -<span class="fl">4</span>, <span class="kw">to</span> <span class="kw">=</span> <span class="fl">6</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fl">0.2</span>)
<span class="no">plots1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fl">2</span>:<span class="fl">8</span>,
                 <span class="kw">function</span>(<span class="no">p</span>) {
                     <span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">X</span> <span class="kw">=</span> <span class="no">z</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"Normal"</span>, <span class="kw">pDegree</span> <span class="kw">=</span> <span class="no">p</span>)
                     <span class="no">g</span> <span class="kw">&lt;-</span> <span class="no">result</span>$<span class="no">stats</span>[, <span class="st">"g"</span>]
                     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">disjointTheta</span>)) +
                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">..count..</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">..count..</span>)),
                                        <span class="kw">color</span> <span class="kw">=</span> <span class="st">"brown"</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">60</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.2</span>) +
                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">g</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>) +
                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">theta</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Density"</span>,
                              <span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"DF = %d"</span>, <span class="no">p</span>))
                })</pre></body></html></div>
<p>Choosing the degrees of freedom to be 7, we now examine the effect of regularization parameter <span class="math inline">\(c0\)</span>.</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="no">plots2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">16</span>, <span class="fl">32</span>),
                 <span class="kw">function</span>(<span class="no">c0</span>) {
                     <span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">X</span> <span class="kw">=</span> <span class="no">z</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"Normal"</span>, <span class="kw">pDegree</span> <span class="kw">=</span> <span class="fl">6</span>,
                                      <span class="kw">c0</span> <span class="kw">=</span> <span class="no">c0</span>)
                     <span class="no">g</span> <span class="kw">&lt;-</span> <span class="no">result</span>$<span class="no">stats</span>[, <span class="st">"g"</span>]
                     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">disjointTheta</span>)) +
                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">..count..</span> / <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">..count..</span>)),
                                        <span class="kw">color</span> <span class="kw">=</span> <span class="st">"brown"</span>, <span class="kw">bins</span> <span class="kw">=</span> <span class="fl">60</span>, <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.2</span>) +
                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">g</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>) +
                         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">theta</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Density"</span>,
                              <span class="kw">title</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"C0 = %.1f"</span>, <span class="no">c0</span>))
                })
<span class="no">plots</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html">mapply</a></span>(<span class="kw">function</span>(<span class="no">x</span>, <span class="no">y</span>) <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">x</span>, <span class="no">y</span>), <span class="no">plots1</span>, <span class="no">plots2</span>)
<span class="fu"><a href="https://rdrr.io/pkg/cowplot/man/plot_grid.html">plot_grid</a></span>(<span class="kw">plotlist</span> <span class="kw">=</span> <span class="no">plots</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>)</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-30-1.png" width="720"></p>
<p>The quantity <span class="math inline">\(S(\alpha)\)</span> is a measure of the strength of the penalty term <span class="math inline">\(c_0\)</span> and is returned by <code>deconv</code> in the result list as a named item <code>S</code>. Below we vary <span class="math inline">\(c_0\)</span> and degrees of freedom from 5 to 7 to gauge the effect of the regularization.</p>
<div class="sourceCode" id="cb34"><html><body><pre class="r"><span class="no">c0_values</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">16</span>, <span class="fl">32</span>)
<span class="no">stable</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
    <span class="kw">c0</span> <span class="kw">=</span> <span class="no">c0_values</span>,
    <span class="kw">`DF 5`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">c0_values</span>, <span class="kw">function</span>(<span class="no">c0</span>) <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">X</span> <span class="kw">=</span> <span class="no">z</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"Normal"</span>, <span class="kw">pDegree</span> <span class="kw">=</span> <span class="fl">5</span>, <span class="kw">c0</span> <span class="kw">=</span> <span class="no">c0</span>)$<span class="no">S</span>),
    <span class="kw">`DF 6`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">c0_values</span>, <span class="kw">function</span>(<span class="no">c0</span>) <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">X</span> <span class="kw">=</span> <span class="no">z</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"Normal"</span>, <span class="kw">pDegree</span> <span class="kw">=</span> <span class="fl">6</span>, <span class="kw">c0</span> <span class="kw">=</span> <span class="no">c0</span>)$<span class="no">S</span>),
    <span class="kw">`DF 7`</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">c0_values</span>, <span class="kw">function</span>(<span class="no">c0</span>) <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">X</span> <span class="kw">=</span> <span class="no">z</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"Normal"</span>, <span class="kw">pDegree</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="kw">c0</span> <span class="kw">=</span> <span class="no">c0</span>)$<span class="no">S</span>)
)
<span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="no">stable</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">c0</th>
<th align="right">DF.5</th>
<th align="right">DF.6</th>
<th align="right">DF.7</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.5</td>
<td align="right">0.0010381</td>
<td align="right">0.0013048</td>
<td align="right">0.0018553</td>
</tr>
<tr class="even">
<td align="right">1.0</td>
<td align="right">0.0029450</td>
<td align="right">0.0034142</td>
<td align="right">0.0042665</td>
</tr>
<tr class="odd">
<td align="right">2.0</td>
<td align="right">0.0082974</td>
<td align="right">0.0090723</td>
<td align="right">0.0102037</td>
</tr>
<tr class="even">
<td align="right">4.0</td>
<td align="right">0.0236310</td>
<td align="right">0.0248144</td>
<td align="right">0.0257369</td>
</tr>
<tr class="odd">
<td align="right">8.0</td>
<td align="right">0.0685852</td>
<td align="right">0.0708393</td>
<td align="right">0.0697542</td>
</tr>
<tr class="even">
<td align="right">16.0</td>
<td align="right">0.1915350</td>
<td align="right">0.2039325</td>
<td align="right">0.2025109</td>
</tr>
<tr class="odd">
<td align="right">32.0</td>
<td align="right">0.4831292</td>
<td align="right">0.5385301</td>
<td align="right">0.5698289</td>
</tr>
</tbody>
</table>
<p>A DF of 6 or 7 captures the bimodality and a choice of <span class="math inline">\(c_0 &lt; 4\)</span> would avoid excessive penalization.</p>
</div>
<div id="binomial-example" class="section level2">
<h2 class="hasAnchor">
<a href="#binomial-example" class="anchor"></a>Binomial Example</h2>
<p>The dataset <code>surg</code> contains data on intestinal surgery on 844 cancer patients. In the study, surgeons removed <em>satellite</em> nodes for later testing. The data consists of pairs <span class="math inline">\((n_i, X_i)\)</span> where <span class="math inline">\(n_i\)</span> is the number of satellites removed and <span class="math inline">\(X_i\)</span> is the number found to be malignant among them.</p>
<p>We assume a binomial model with <span class="math inline">\(X_i \sim Binomial(n_i, \theta_i)\)</span> with <span class="math inline">\(\theta_i\)</span> being the probability of any one satellite site being malignant for the <span class="math inline">\(i\)</span>th patient.</p>
<p>We take <span class="math inline">\(\mathcal{T} = (0.01, 0.02,\ldots, 0.09)\)</span>, so <span class="math inline">\(m = 99.\)</span> We take <span class="math inline">\(Q\)</span> to be the default 5-degree natural spline with columns standardized to mean 0 and sum of squares equal to 1. The penalization parameter is set to 1. The figure below shows the estimated prior density of <span class="math inline">\(g(\theta)\)</span>.</p>
<div class="sourceCode" id="cb35"><html><body><pre class="r"><span class="no">tau</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="kw">from</span> <span class="kw">=</span> <span class="fl">0.01</span>, <span class="kw">to</span> <span class="kw">=</span> <span class="fl">0.99</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fl">0.01</span>)
<span class="no">result</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">X</span> <span class="kw">=</span> <span class="no">surg</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"Binomial"</span>, <span class="kw">c0</span> <span class="kw">=</span> <span class="fl">1</span>)
<span class="no">d</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="no">result</span>$<span class="no">stats</span>)
<span class="no">indices</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">5</span>, <span class="fl">99</span>, <span class="fl">5</span>)
<span class="no">errorX</span> <span class="kw">&lt;-</span> <span class="no">tau</span>[<span class="no">indices</span>]
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>, <span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">g</span>)) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_errorbar</a></span>(<span class="kw">data</span> <span class="kw">=</span> <span class="no">d</span>[<span class="no">indices</span>, ],
                  <span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">theta</span>, <span class="kw">ymin</span> <span class="kw">=</span> <span class="no">g</span> - <span class="no">SE.g</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">g</span> + <span class="no">SE.g</span>),
                  <span class="kw">width</span> <span class="kw">=</span> <span class="fl">.01</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="st">"blue"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">theta</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="fu">g</span>(<span class="no">theta</span>), <span class="st">" +/- SE"</span>)))</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-32-1.png" width="700"></p>
<p>The complete table of estimates and standard errors is also available.</p>
<div class="sourceCode" id="cb36"><html><body><pre class="r"><span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="no">d</span>[<span class="no">indices</span>, ], <span class="kw">row.names</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">theta</th>
<th align="right">g</th>
<th align="right">SE.g</th>
<th align="right">G</th>
<th align="right">SE.G</th>
<th align="right">Bias.g</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.05</td>
<td align="right">0.0463457</td>
<td align="right">0.0015738</td>
<td align="right">0.4000686</td>
<td align="right">0.0187280</td>
<td align="right">-0.0001386</td>
</tr>
<tr class="even">
<td align="right">0.10</td>
<td align="right">0.0151816</td>
<td align="right">0.0014905</td>
<td align="right">0.5227891</td>
<td align="right">0.0179368</td>
<td align="right">0.0005557</td>
</tr>
<tr class="odd">
<td align="right">0.15</td>
<td align="right">0.0063608</td>
<td align="right">0.0009530</td>
<td align="right">0.5679756</td>
<td align="right">0.0177951</td>
<td align="right">0.0004028</td>
</tr>
<tr class="even">
<td align="right">0.20</td>
<td align="right">0.0039081</td>
<td align="right">0.0006332</td>
<td align="right">0.5910638</td>
<td align="right">0.0182757</td>
<td align="right">0.0002736</td>
</tr>
<tr class="odd">
<td align="right">0.25</td>
<td align="right">0.0038724</td>
<td align="right">0.0005167</td>
<td align="right">0.6098155</td>
<td align="right">0.0187490</td>
<td align="right">0.0002012</td>
</tr>
<tr class="even">
<td align="right">0.30</td>
<td align="right">0.0053573</td>
<td align="right">0.0005917</td>
<td align="right">0.6330463</td>
<td align="right">0.0188231</td>
<td align="right">0.0000993</td>
</tr>
<tr class="odd">
<td align="right">0.35</td>
<td align="right">0.0082256</td>
<td align="right">0.0010482</td>
<td align="right">0.6679794</td>
<td align="right">0.0180358</td>
<td align="right">-0.0001306</td>
</tr>
<tr class="even">
<td align="right">0.40</td>
<td align="right">0.0111402</td>
<td align="right">0.0015163</td>
<td align="right">0.7184355</td>
<td align="right">0.0170109</td>
<td align="right">-0.0004107</td>
</tr>
<tr class="odd">
<td align="right">0.45</td>
<td align="right">0.0111343</td>
<td align="right">0.0011809</td>
<td align="right">0.7755223</td>
<td align="right">0.0167801</td>
<td align="right">-0.0003743</td>
</tr>
<tr class="even">
<td align="right">0.50</td>
<td align="right">0.0086588</td>
<td align="right">0.0009940</td>
<td align="right">0.8242825</td>
<td align="right">0.0155204</td>
<td align="right">-0.0000980</td>
</tr>
<tr class="odd">
<td align="right">0.55</td>
<td align="right">0.0058962</td>
<td align="right">0.0010407</td>
<td align="right">0.8590792</td>
<td align="right">0.0135817</td>
<td align="right">0.0001197</td>
</tr>
<tr class="even">
<td align="right">0.60</td>
<td align="right">0.0039564</td>
<td align="right">0.0008251</td>
<td align="right">0.8823476</td>
<td align="right">0.0125338</td>
<td align="right">0.0002037</td>
</tr>
<tr class="odd">
<td align="right">0.65</td>
<td align="right">0.0028839</td>
<td align="right">0.0005341</td>
<td align="right">0.8986379</td>
<td align="right">0.0120984</td>
<td align="right">0.0002143</td>
</tr>
<tr class="even">
<td align="right">0.70</td>
<td align="right">0.0023398</td>
<td align="right">0.0004140</td>
<td align="right">0.9112647</td>
<td align="right">0.0114461</td>
<td align="right">0.0002039</td>
</tr>
<tr class="odd">
<td align="right">0.75</td>
<td align="right">0.0021301</td>
<td align="right">0.0004763</td>
<td align="right">0.9222208</td>
<td align="right">0.0103935</td>
<td align="right">0.0001911</td>
</tr>
<tr class="even">
<td align="right">0.80</td>
<td align="right">0.0021935</td>
<td align="right">0.0005645</td>
<td align="right">0.9329514</td>
<td align="right">0.0092023</td>
<td align="right">0.0001796</td>
</tr>
<tr class="odd">
<td align="right">0.85</td>
<td align="right">0.0025512</td>
<td align="right">0.0005742</td>
<td align="right">0.9448671</td>
<td align="right">0.0082261</td>
<td align="right">0.0001632</td>
</tr>
<tr class="even">
<td align="right">0.90</td>
<td align="right">0.0032568</td>
<td align="right">0.0005083</td>
<td align="right">0.9595831</td>
<td align="right">0.0072551</td>
<td align="right">0.0001253</td>
</tr>
<tr class="odd">
<td align="right">0.95</td>
<td align="right">0.0044141</td>
<td align="right">0.0007505</td>
<td align="right">0.9791329</td>
<td align="right">0.0048537</td>
<td align="right">0.0000355</td>
</tr>
</tbody>
</table>
<p>The empirical Bayes estimate of the prior distribution puts most of its mass on the small values as can be seem below.</p>
<div class="sourceCode" id="cb37"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"Mass below .20 = %0.2f\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">d</span>[<span class="fl">1</span>:<span class="fl">20</span>, <span class="st">"g"</span>])))</pre></body></html></div>
<pre><code>## Mass below .20 = 0.59</code></pre>
<div class="sourceCode" id="cb39"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"Mass above .80 = %0.2f\n"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">d</span>[<span class="fl">80</span>:<span class="fl">99</span>, <span class="st">"g"</span>])))</pre></body></html></div>
<pre><code>## Mass above .80 = 0.07</code></pre>
<div id="posterior-estimates" class="section level3">
<h3 class="hasAnchor">
<a href="#posterior-estimates" class="anchor"></a>Posterior Estimates</h3>
<p>The posterior distribution of <span class="math inline">\(\theta_i\)</span> given <span class="math inline">\((n_i, X_i)\)</span> is computed using Bayes rule as</p>
<p><span class="math display">\[
\hat{g} (\theta | X_i = x_i, n_i) = 
    \frac{g_{\hat{\alpha}} (\theta) {n_i \choose x_i} 
    \theta^{x_i} (1 - \theta)^{n_i-x_i}} {f_{\hat{\alpha}}(n_i, x_i)}
\]</span></p>
<p>where the denominator is given by</p>
<p><span class="math display">\[
f_\alpha(n_i, x_i) = \int_0^1{n_i \choose x_i}
    \theta^{x_i}(1-\theta)^{n_i-x_i}g_\alpha(\theta)\,d\theta.
\]</span></p>
<p>with the mle <span class="math inline">\(\hat{\alpha}\)</span> in place of <span class="math inline">\(\alpha\)</span>.</p>
<p>Since <span class="math inline">\(g(\theta)\)</span> is discrete, the integrals are mere sums as shown below.</p>
<div class="sourceCode" id="cb41"><html><body><pre class="r"><span class="no">theta</span> <span class="kw">&lt;-</span> <span class="no">result</span>$<span class="no">stats</span>[, <span class="st">'theta'</span>]
<span class="no">gTheta</span> <span class="kw">&lt;-</span> <span class="no">result</span>$<span class="no">stats</span>[, <span class="st">'g'</span>]

<span class="no">f_alpha</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">n_k</span>, <span class="no">x_k</span>) {
    <span class="co">## .01 is the delta_theta in the Riemann sum</span>
    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x_k</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="no">n_k</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="no">theta</span>) * <span class="no">gTheta</span>) * <span class="fl">.01</span>
}

<span class="no">g_theta_hat</span> <span class="kw">&lt;-</span> <span class="kw">function</span>(<span class="no">n_k</span>, <span class="no">x_k</span>) {
    <span class="no">gTheta</span> * <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">dbinom</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x_k</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="no">n_k</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="no">theta</span>) / <span class="fu">f_alpha</span>(<span class="no">n_k</span>, <span class="no">x_k</span>)
}</pre></body></html></div>
<p>We plot a few posterior distributions.</p>
<div class="sourceCode" id="cb42"><html><body><pre class="r"><span class="no">g1</span> <span class="kw">&lt;-</span> <span class="fu">g_theta_hat</span>(<span class="kw">x_k</span> <span class="kw">=</span> <span class="fl">7</span>, <span class="kw">n_k</span> <span class="kw">=</span> <span class="fl">32</span>)
<span class="no">g2</span> <span class="kw">&lt;-</span> <span class="fu">g_theta_hat</span>(<span class="kw">x_k</span> <span class="kw">=</span> <span class="fl">3</span>, <span class="kw">n_k</span> <span class="kw">=</span> <span class="fl">6</span>)
<span class="no">g3</span> <span class="kw">&lt;-</span> <span class="fu">g_theta_hat</span>(<span class="kw">x_k</span> <span class="kw">=</span> <span class="fl">17</span>, <span class="kw">n_k</span> <span class="kw">=</span> <span class="fl">18</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">theta</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">g1</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"magenta"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span>(<span class="fl">0</span>, <span class="fl">10</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">theta</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">g2</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw">mapping</span> <span class="kw">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">theta</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">g3</span>), <span class="kw">col</span> <span class="kw">=</span> <span class="st">"blue"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="no">theta</span>), <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span>(<span class="fu">g</span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="no">theta</span>, <span class="st">"|(x, n)"</span>)))) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, <span class="kw">x</span> <span class="kw">=</span> <span class="fl">0.15</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fl">4.25</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"x=7, n=32"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, <span class="kw">x</span> <span class="kw">=</span> <span class="fl">0.425</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fl">4.25</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"x=3, n=6"</span>) +
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span>(<span class="st">"text"</span>, <span class="kw">x</span> <span class="kw">=</span> <span class="fl">0.85</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="fl">7.5</span>, <span class="kw">label</span> <span class="kw">=</span> <span class="st">"x=17, n=18"</span>)</pre></body></html></div>
<p><img src="deconvolution_files/figure-html/unnamed-chunk-36-1.png" width="700"></p>
<p>The empirical Bayes posterior estimate <span class="math inline">\(\theta^{EB}\)</span> for patients 34, 40, and 679 in the dataset for example is</p>
<div class="sourceCode" id="cb43"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">"Empirical Bayes Estimate: %f\n"</span>, <span class="fl">0.01</span> * <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">theta</span> * <span class="no">g2</span>)))</pre></body></html></div>
<pre><code>## Empirical Bayes Estimate: 0.453516</code></pre>
</div>
<div id="bootstrap-comparison-1" class="section level3">
<h3 class="hasAnchor">
<a href="#bootstrap-comparison-1" class="anchor"></a>Bootstrap Comparison</h3>
<p>As a check on the estimates of standard error and bias provided by <code>deconv</code>, we compare the results with what we obtain using a parametric boostrap.</p>
<p>The boostrap is run as follows. For each of 1000 runs, 844 simulated realizations <span class="math inline">\(\hat{\Theta}^*\)</span> are sampled from density <span class="math inline">\(\hat{g}.\)</span> Each gave an <span class="math inline">\(X_i^* \sim Binomial(n_i, \Theta_i^*)\)</span> with <span class="math inline">\(n_i\)</span> the <span class="math inline">\(i\)</span>th sample in the original data set. Finally, <span class="math inline">\(\hat{\alpha}\)</span> was computed using <code>deconv</code>.</p>
<div class="sourceCode" id="cb45"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">32776</span>)
<span class="no">B</span> <span class="kw">&lt;-</span> <span class="fl">1000</span>
<span class="no">gHat</span> <span class="kw">&lt;-</span> <span class="no">d</span>$<span class="no">g</span>
<span class="no">N</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">surg</span>)

<span class="no">genBootSample</span> <span class="kw">&lt;-</span> <span class="kw">function</span>() {
    <span class="no">thetaStar</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="no">tau</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="no">N</span>, <span class="kw">replace</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="no">gHat</span>)
    <span class="no">sStar</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="no">N</span>),
                    <span class="kw">function</span>(<span class="no">i</span>)
                        <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html">rbinom</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">1</span> , <span class="kw">size</span> <span class="kw">=</span> <span class="no">surg</span>$<span class="no">n</span>[<span class="no">i</span>], <span class="kw">prob</span> <span class="kw">=</span> <span class="no">thetaStar</span>[<span class="no">i</span>]))
    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">n</span> <span class="kw">=</span> <span class="no">surg</span>$<span class="no">n</span>, <span class="kw">s</span> <span class="kw">=</span> <span class="no">sStar</span>)
}

<span class="no">bootResults</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span>(<span class="no">B</span>),
                      <span class="kw">function</span>(<span class="no">k</span>) {
                          <span class="no">surgBoot</span> <span class="kw">&lt;-</span> <span class="fu">genBootSample</span>()
                          <span class="no">mat</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/deconv.html">deconv</a></span>(<span class="kw">tau</span> <span class="kw">=</span> <span class="no">tau</span>, <span class="kw">X</span> <span class="kw">=</span> <span class="no">surgBoot</span>, <span class="kw">family</span> <span class="kw">=</span> <span class="st">"Binomial"</span>,
                                        <span class="kw">c0</span> <span class="kw">=</span> <span class="fl">1</span>)$<span class="no">stats</span>
                          <span class="no">mat</span>[, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"g"</span>, <span class="st">"Bias.g"</span>)]
                      })

<span class="no">gBoot</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">bootResults</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>[, <span class="fl">1</span>])
<span class="no">BiasBoot</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">bootResults</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>[, <span class="fl">2</span>])

<span class="no">indices</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>, <span class="fl">99</span>, <span class="fl">11</span>), <span class="fl">99</span>)

<span class="no">table2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">theta</span> <span class="kw">=</span> <span class="no">tau</span>,
                     <span class="kw">gTheta</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">gHat</span> * <span class="fl">100</span>, <span class="fl">3</span>),
                     <span class="kw">sdFormula</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">d</span>$<span class="no">SE.g</span> * <span class="fl">100</span>, <span class="fl">3</span>),
                     <span class="kw">sdSimul</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">gBoot</span>, <span class="fl">1</span>, <span class="no">sd</span>) * <span class="fl">100</span>, <span class="fl">3</span>),
                     <span class="kw">BiasFormula</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="no">d</span>$<span class="no">Bias.g</span> * <span class="fl">100</span>, <span class="fl">3</span>),
                     <span class="kw">BiasSimul</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">BiasBoot</span>, <span class="fl">1</span>, <span class="no">mean</span>) * <span class="fl">100</span>, <span class="fl">3</span>))[ <span class="no">indices</span>, ]</pre></body></html></div>
<p>We print out some estimated quantities for comparison.</p>
<div class="sourceCode" id="cb46"><html><body><pre class="r"><span class="kw pkg">knitr</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span>(<span class="no">table2</span>, <span class="kw">row.names</span> <span class="kw">=</span> <span class="fl">FALSE</span>)</pre></body></html></div>
<table class="table">
<thead><tr class="header">
<th align="right">theta</th>
<th align="right">gTheta</th>
<th align="right">sdFormula</th>
<th align="right">sdSimul</th>
<th align="right">BiasFormula</th>
<th align="right">BiasSimul</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">0.01</td>
<td align="right">12.326</td>
<td align="right">0.870</td>
<td align="right">0.911</td>
<td align="right">-0.482</td>
<td align="right">-0.543</td>
</tr>
<tr class="even">
<td align="right">0.12</td>
<td align="right">1.033</td>
<td align="right">0.127</td>
<td align="right">0.135</td>
<td align="right">0.051</td>
<td align="right">0.058</td>
</tr>
<tr class="odd">
<td align="right">0.23</td>
<td align="right">0.369</td>
<td align="right">0.054</td>
<td align="right">0.061</td>
<td align="right">0.023</td>
<td align="right">0.027</td>
</tr>
<tr class="even">
<td align="right">0.34</td>
<td align="right">0.757</td>
<td align="right">0.093</td>
<td align="right">0.091</td>
<td align="right">-0.007</td>
<td align="right">-0.008</td>
</tr>
<tr class="odd">
<td align="right">0.45</td>
<td align="right">1.113</td>
<td align="right">0.118</td>
<td align="right">0.113</td>
<td align="right">-0.037</td>
<td align="right">-0.036</td>
</tr>
<tr class="even">
<td align="right">0.56</td>
<td align="right">0.543</td>
<td align="right">0.102</td>
<td align="right">0.097</td>
<td align="right">0.015</td>
<td align="right">0.016</td>
</tr>
<tr class="odd">
<td align="right">0.67</td>
<td align="right">0.262</td>
<td align="right">0.046</td>
<td align="right">0.049</td>
<td align="right">0.021</td>
<td align="right">0.024</td>
</tr>
<tr class="even">
<td align="right">0.78</td>
<td align="right">0.213</td>
<td align="right">0.053</td>
<td align="right">0.050</td>
<td align="right">0.018</td>
<td align="right">0.018</td>
</tr>
<tr class="odd">
<td align="right">0.89</td>
<td align="right">0.308</td>
<td align="right">0.052</td>
<td align="right">0.046</td>
<td align="right">0.014</td>
<td align="right">0.013</td>
</tr>
<tr class="even">
<td align="right">0.99</td>
<td align="right">0.575</td>
<td align="right">0.158</td>
<td align="right">0.157</td>
<td align="right">-0.010</td>
<td align="right">-0.014</td>
</tr>
</tbody>
</table>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://statweb.stanford.edu/~ckirby/brad/">Bradley Efron</a>, <a href="https://web.stanford.edu/~naras">Balasubramanian Narasimhan</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
